<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEMæ¶‚é¸¦æ¡£æ¡ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/3.1.0/openseadragon.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
    /* --- åŸºæœ¬æ ·å¼ã€ä¸»é¢˜ç­‰ --- */
    :root {
        --bg-color: #fff; --text-color: #333; --card-bg: #f9f9f9;
        --card-shadow: 0 4px 15px rgba(0,0,0,.08); --accent-color: #a0522d;
        --hover-color: #8b4513; --viewer-bg: #000; --border-color: #e0e0e0;
        --header-bg: #fff; --footer-bg: #333; --footer-text: #ccc;
        --modal-bg: rgba(0, 0, 0, 0.6); --modal-content-bg: #fff;
    }
    .dark-mode {
        --bg-color: #1a1a1a; --text-color: #eee; --card-bg: #2b2b2b;
        --card-shadow: 0 4px 15px rgba(0,0,0,.3); --accent-color: #c8a16a;
        --hover-color: #e0b880; --viewer-bg: #111; --border-color: #444;
        --header-bg: #222; --footer-bg: #111; --footer-text: #999;
        --modal-content-bg: #2b2b2b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; transition: background-color .3s, color .3s, border-color .3s; }
    body { font-family: 'Noto Serif SC', serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    /* --- é¡µçœ‰ä¿®æ”¹ --- */
    .main-header { background-color: var(--header-bg); padding: 10px 0; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 999; }
    .main-header .container { justify-content: space-between; align-items: center; display: flex; flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */ }
    .header-title { /* é¡µçœ‰å·¦ä¸Šè§’æ ‡é¢˜ */
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--accent-color);
        margin-right: auto; /* æ¨å¼€å¯¼èˆªå’ŒæŒ‰é’® */
        padding: 5px 0; /* å¢åŠ å‚ç›´é—´è· */
        order: 1; /* é»˜è®¤é¡ºåº */
        white-space: nowrap; /* é˜²æ­¢æ ‡é¢˜æ¢è¡Œ */
    }
    .main-nav { order: 3; width: 100%; /* å°å±å¹•æ—¶å æ»¡ */ margin-top: 10px; /* å°å±å¹•æ—¶ä¸æ ‡é¢˜é—´è· */ }
    .main-nav ul { align-items: center; display: flex; list-style: none; justify-content: center; /* å¯¼èˆªå±…ä¸­ */ padding-left: 0; }
    .main-nav ul li { margin: 0 15px; /* è°ƒæ•´èœå•é¡¹é—´è· */ position: relative; }
    .main-nav ul li a { text-decoration: none; color: var(--text-color); font-size: 1rem; transition: color .2s; }
    .main-nav ul li a:hover, .main-nav ul li a.active { color: var(--accent-color); }
    .header-actions { align-items: center; display: flex; order: 2; padding: 5px 0; }
    .theme-toggle {
        background: 0 0;
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: .85rem;
        transition: background-color .2s, color .2s;
        white-space: nowrap; /* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
    }
    .theme-toggle:hover { background-color: var(--accent-color); color: #fff; }

    /* --- Hero éƒ¨åˆ† (ä¿æŒä¸å˜) --- */
    .hero { background: linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),url(assets/placeholder-hero.jpg) no-repeat center center/cover; color:#fff; padding:60px 20px; text-align:center; margin-bottom:40px; }
    .hero h1 { font-size:2.5rem; margin-bottom:15px; text-shadow:1px 1px 3px rgba(0,0,0,.5); }
    .hero p { font-size:1.1rem; max-width:600px; margin:0 auto; text-shadow:1px 1px 3px rgba(0,0,0,.5); }

    /* --- ä¸»å†…å®¹å’Œç”»å»Šæ ·å¼ (å¤§éƒ¨åˆ†ä¸å˜) --- */
    main { padding: 40px 0; }
    .section-title { font-size: 1.8rem; color: var(--accent-color); margin-bottom: 30px; text-align: center; position: relative; padding-bottom: 10px; }
    .section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background-color: var(--accent-color); }
    .breadcrumb { margin-bottom: 30px; padding: 12px 15px; background-color: var(--card-bg); border-radius: 5px; border: 1px solid var(--border-color); font-size: .9rem; }
    .breadcrumb a { color: var(--accent-color); text-decoration: none; margin-right: 8px; }
    .breadcrumb a:hover { text-decoration: underline; color: var(--hover-color); }
    .breadcrumb span { margin: 0 5px; color: var(--text-color); opacity: .7; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill,minmax(min(200px, 100%), 1fr)); /* è°ƒæ•´æœ€å°å°ºå¯¸ */ gap: 20px; /* è°ƒæ•´é—´è· */ }
    .folder, .image-item { background-color: var(--card-bg); border-radius: 8px; overflow: hidden; box-shadow: var(--card-shadow); cursor: pointer; transition: transform 0.25s ease-out, box-shadow 0.25s ease-out; position: relative; aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--border-color); background-size: cover; background-position: center; background-repeat: no-repeat; }
    .folder.loading-cover::after { content: ''; display: block; width: 30px; height: 30px; border: 3px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: var(--accent-color); animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .folder:not(.has-cover):not(.loading-cover)::before { content: 'ğŸ“'; font-size: 3.5rem; color: var(--accent-color); opacity: 0.5; margin-bottom: 10px; }
    .folder.has-error::before { content: 'âš ï¸'; font-size: 3.5rem; color: red; opacity: 0.7; }
    .folder-name { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.75); color: #333; padding: 6px 12px; font-size: 1.5rem; /* è°ƒæ•´å­—ä½“å¤§å° */ font-weight: bold; text-align: center; width: auto; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-radius: 0; border: 1px solid rgba(0, 0, 0, 0.1); }
    .dark-mode .folder-name { background-color: rgba(50, 50, 50, 0.75); color: #eee; border: 1px solid rgba(255, 255, 255, 0.1); }
    .folder:hover, .image-item:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
    .image-item img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; transition: transform 0.3s ease; }
    .image-item:hover img { transform: scale(1.05); }
    .image-name { /* ä¿®æ”¹ï¼šç§»é™¤å›¾ç‰‡åç§°æ˜¾ç¤º */ display: none; }
    .empty-message { grid-column: 1 / -1; text-align: center; padding: 60px 20px; background-color: var(--card-bg); border-radius: 8px; border: 1px dashed var(--border-color); color: var(--text-color); opacity: 0.8; }
    .loader { display: inline-block; width: 25px; height: 25px; border: 3px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: var(--accent-color); animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- å›¾ç‰‡æŸ¥çœ‹å™¨æ ·å¼ (ä¿æŒä¸å˜) --- */
    #image-viewer{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--viewer-bg);z-index:1000}#viewer-container{width:100%;height:100%}.close-viewer{position:absolute;top:20px;right:20px;color:#fff;font-size:2rem;cursor:pointer;z-index:1001;background-color:rgba(0,0,0,.5);width:40px;height:40px;border-radius:50%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;line-height:1}.close-viewer:hover{background-color:rgba(0,0,0,.7)}.info-panel{position:absolute;bottom:0;left:0;width:100%;background-color:rgba(0,0,0,.7);color:#fff;padding:10px 20px;-webkit-transform:translateY(100%);transform:translateY(100%);-webkit-transition:-webkit-transform .3s ease;transition:-webkit-transform .3s ease;transition:transform .3s ease;transition:transform .3s ease,-webkit-transform .3s ease;z-index:1001;font-size:.9rem}.info-panel.visible{-webkit-transform:translateY(0);transform:translateY(0)}.info-panel h3{margin-bottom:5px;font-size:1rem}.info-panel p{margin-bottom:3px;line-height:1.4}.info-toggle{position:absolute;bottom:20px;left:20px;background-color:rgba(0,0,0,.5);color:#fff;border:none;padding:8px 15px;border-radius:20px;cursor:pointer;z-index:1001;font-size:.9rem;-webkit-transition:background-color .3s;transition:background-color .3s}.info-toggle:hover{background-color:rgba(0,0,0,.7)}.controls{position:absolute;top:20px;left:20px;z-index:1001;display:-webkit-box;display:-ms-flexbox;display:flex;gap:10px}.control-btn{background-color:rgba(0,0,0,.5);color:#fff;border:none;width:40px;height:40px;border-radius:50%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;cursor:pointer;font-size:1.2rem;-webkit-transition:background-color .3s,-webkit-transform .2s;transition:background-color .3s,-webkit-transform .2s;transition:background-color .3s,transform .2s;transition:background-color .3s,transform .2s,-webkit-transform .2s}.control-btn:hover{background-color:rgba(0,0,0,.7);-webkit-transform:scale(1.1);transform:scale(1.1)}.openseadragon-container .openseadragon-controls{display:none!important}

    /* --- é¡µè„šä¿®æ”¹ --- */
    .main-footer { background-color: var(--footer-bg); color: var(--footer-text); padding: 30px 0; margin-top: 60px; font-size: .9rem; border-top: 3px solid var(--accent-color); }
    .main-footer .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; /* å¢åŠ å…ƒç´ é—´è· */ }
    .footer-left { display: flex; align-items: center; gap: 10px; order: 1; } /* Logo å’Œæ–‡å­—å®¹å™¨ */
    #footer-logo { height: 40px; /* ç¨å¾®æ”¾å¤§ Logo */ width: auto; vertical-align: middle; }
    .footer-logo-text { font-size: 1.1rem; /* è°ƒæ•´æ–‡å­—å¤§å° */ font-weight: bold; white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */ }
    .footer-center { text-align: center; order: 3; width: 100%; margin-top: 15px; /* å°å±å¹•æ—¶å‘ä¸‹æ¨ */ } /* ç‰ˆæƒä¿¡æ¯ */
    .footer-right { display: flex; gap: 20px; order: 2; margin-left: auto; /* é»˜è®¤æ¨åˆ°å³è¾¹ */ } /* ç¤¾äº¤é“¾æ¥ */
    .footer-right a {
        color: var(--footer-text);
        text-decoration: none;
        font-size: 1.1rem;
        transition: color 0.2s;
        cursor: pointer;
        white-space: nowrap; /* é˜²æ­¢é“¾æ¥å†…æ–‡å­—æ¢è¡Œ */
    }
    .footer-right a:hover { color: #fff; }

    /* --- å¼¹çª— Modal æ ·å¼ --- */
    .modal { display: none; /* é»˜è®¤éšè— */ position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); align-items: center; justify-content: center; }
    .modal-content { background-color: var(--modal-content-bg); margin: auto; padding: 30px; border: 1px solid var(--border-color); width: 90%; max-width: 450px; /* é™åˆ¶æœ€å¤§å®½åº¦ */ border-radius: 8px; position: relative; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,.2); }
    .modal-close { color: var(--text-color); position: absolute; top: 10px; right: 20px; font-size: 2rem; font-weight: bold; cursor: pointer; line-height: 1; opacity: 0.7; }
    .modal-close:hover { color: var(--accent-color); opacity: 1; }
    .modal-body img { max-width: 100%; height: auto; display: block; margin: 15px auto; border: 1px solid var(--border-color); }
    .modal-body p { margin-top: 15px; text-align: left; line-height: 1.7; }

    /* --- å“åº”å¼è®¾è®¡ --- */
    @media (min-width: 768px) {
         /* é¡µçœ‰å¸ƒå±€ */
        .main-header .container { flex-wrap: nowrap; }
        .header-title {
            flex-shrink: 0; /* é˜²æ­¢æ ‡é¢˜æ”¶ç¼© */
        }
        .main-nav {
            order: 2;
            width: auto; /* æ”¹å› auto */
            margin-top: 0;
            margin-left: auto;
            margin-right: auto;
        }
        .header-actions {
            order: 3;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®åŒºåŸŸæ”¶ç¼© */
        }
        .main-nav ul { justify-content: center; } /* ä¿æŒå¯¼èˆªå±…ä¸­ */

        /* é¡µè„šå¸ƒå±€ */
        .main-footer .container { flex-wrap: nowrap; }
        .footer-center {
            order: 2;
            /* width: 100%; */ /* <<< ç§»é™¤æ­¤è¡Œ */
            margin-left: auto;
            margin-right: auto;
            margin-top: 0;
            text-align: center; /* ç¡®ä¿æ–‡æœ¬å±…ä¸­ */
        }
        .footer-right {
            order: 3;
            /* margin-left: auto; */ /* è¿™è¡Œåœ¨ .footer-right åŸºæœ¬æ ·å¼é‡Œæœ‰äº†ï¼Œè¿™é‡Œä¸ç”¨é‡å¤ */
        }
        .footer-left {
            order: 1;
            margin-right: auto; /* å·¦ä¾§å†…å®¹é å·¦ */
        }

        /* è°ƒæ•´ç”»å»Šåˆ—æ•° */
         .gallery { grid-template-columns: repeat(auto-fill,minmax(min(250px, 100%), 1fr)); }
         .folder-name { font-size: 2.0rem; }
         .folder:not(.has-cover):not(.loading-cover)::before { font-size: 4rem; margin-bottom: 15px; }
         .folder.has-error::before { font-size: 4rem; }
         .hero h1 {font-size: 2.8rem;}
         .hero p {font-size: 1.2rem;}
    }
    @media (max-width: 480px) {
        /* é’ˆå¯¹éå¸¸å°çš„å±å¹•è¿›ä¸€æ­¥è°ƒæ•´ */
        .main-nav ul li { margin: 0 8px; }
        .gallery { gap: 10px; grid-template-columns: repeat(auto-fill,minmax(min(150px, 100%), 1fr)); }
        .folder-name { font-size: 1.2rem; padding: 4px 8px;}
         .folder:not(.has-cover):not(.loading-cover)::before { font-size: 3rem; }
         .folder.has-error::before { font-size: 3rem; }
        .footer-left, .footer-right { flex-direction: column; align-items: flex-start; gap: 5px; } /* é¡µè„šå…ƒç´ å‚ç›´å †å  */
        .footer-right { margin-left: 0; } /* ç§»é™¤æ¨åˆ°å³è¾¹çš„æ•ˆæœ */
        .modal-content { padding: 20px; }
    }
</style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-title">SYSTEMæ¶‚é¸¦æ¡£æ¡ˆ</div>
            <nav class="main-nav">
                <ul>
                    <li><a href="#/" class="active">é¦–é¡µ</a></li>
                    <li><a href="#" id="about-link">å…³äº</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <button class="theme-toggle" id="theme-toggle">åˆ‡æ¢æ¨¡å¼</button>
            </div>
        </div>
    </header>

    <section class="hero"><h1>SYSTEMæ¶‚é¸¦æ¡£æ¡ˆ</h1><p>å…³äºSYSTEMç³»ç»Ÿäº‘æµ·å¤§å¦çš„è®°å¿†</p></section>

    <main>
        <div class="container">
            <div class="breadcrumb" id="breadcrumb"><a href="#/" data-path="">æ ¹ç›®å½•</a></div>
            <h2 class="section-title" id="gallery-title">å½“å‰ç›®å½•</h2>
            <div class="gallery" id="gallery">
                <div class="empty-message"><div class="loader"></div>æ­£åœ¨åŠ è½½...</div>
            </div>
        </div>
    </main>

    <div id="image-viewer">
        <div class="close-viewer" id="close-viewer">Ã—</div>
        <div class="controls">
            <button class="control-btn" id="zoom-in" title="æ”¾å¤§">+</button>
            <button class="control-btn" id="zoom-out" title="ç¼©å°">-</button>
            <button class="control-btn" id="home" title="é‡ç½®è§†å›¾">âŒ‚</button>
            <button class="control-btn" id="full-page" title="å…¨å±">â›¶</button>
        </div>
        <button class="info-toggle" id="info-toggle">æ˜¾ç¤ºä¿¡æ¯</button>
        <div class="info-panel" id="info-panel">
            <h3 id="image-title"></h3>
            <p id="image-info"></p>
        </div>
        <div id="viewer-container"></div>
    </div>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-left">
                <a class="logo-link" title="è¿”å›é¦–é¡µ">
                    <img src="assets/logo.JPG" alt="SYSTEM Logo" id="footer-logo">
                </a>
                <span class="footer-logo-text">SYSTEMç³»ç»Ÿ</span>
            </div>

            <div class="footer-center">&copy; 2025.01.11 ç‰ˆæƒæ‰€æœ‰</div>

            <div class="footer-right">
                <a href="#" title="wechat" id="fb-link">å¾®ä¿¡</a>
                <a href="#" title="Instagram" id="ig-link">IG</a>
            </div>
        </div>
    </footer>


    <div id="social-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="social-modal">&times;</span>
            <div class="modal-body">
                <img id="qr-code-image" src="" alt="QR Code">
            </div>
        </div>
    </div>

    <div id="about-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="about-modal">&times;</span>
            <div class="modal-body">
                <h3>å…³äº SYSTEM æ¶‚é¸¦æ¡£æ¡ˆ</h3>
                <p>æœ¬ç½‘ç«™æ‰€æœ‰ç…§ç‰‡å‡ç”±Orpheusæ‹æ‘„ã€‚åœ¨SYSTEMç³»ç»Ÿæœ€åä¸€æ—¥ä¹‹åï¼Œä»–è§‰å¾—æœ‰å¿…è¦å°†ç©å®¶ä»¬åœ¨æ­¤ç•™ä¸‹çš„ç—•è¿¹æ°¸ä¹…åœ°ä¿å­˜ä¸‹æ¥ã€‚è¿™äº›å¢™é¢çš„æ¶‚é¸¦ç»ˆå°†è¢«å‰¥è½ï¼Œä½†æ˜¯å®ƒä»¬æ›¾ç»å­˜åœ¨è¿‡ã€‚</p>
                <p>å¦‚æœ‰é—®é¢˜è¯·è”ç³»ï¼š</p>
                <img src="assets/about-qr.JPG" alt="å…³äºæˆ‘ä»¬ QR Code">
            </div>
        </div>
    </div>


    <script>
        // --- DOM Element Variables ---
        const galleryElement = document.getElementById('gallery');
        const galleryTitleElement = document.getElementById('gallery-title');
        const breadcrumbElement = document.getElementById('breadcrumb');
        const themeToggle = document.getElementById('theme-toggle');
        const imageViewer = document.getElementById('image-viewer');
        const closeViewer = document.getElementById('close-viewer');
        const viewerContainer = document.getElementById('viewer-container');
        const imageTitle = document.getElementById('image-title');
        const imageInfo = document.getElementById('image-info');
        const infoPanel = document.getElementById('info-panel');
        const infoToggle = document.getElementById('info-toggle');
        const zoomIn = document.getElementById('zoom-in');
        const zoomOut = document.getElementById('zoom-out');
        const home = document.getElementById('home');
        const fullPage = document.getElementById('full-page');
        const mainNavLinks = document.querySelectorAll('.main-nav a'); // For active link highlighting

        // --- Modal Related Elements (Based on your final HTML) ---
        // Note: Your final HTML has #about-link in nav but not the other links
        // Adjust if you add About/Contact links back to nav or use other triggers
        const aboutLink = document.querySelector('.main-nav a[href="#"]'); // Assuming 'å…³äº' link triggers about modal
        const igLink = document.getElementById('ig-link');     // Assuming footer IG link
        const fbLink = document.getElementById('fb-link');     // Assuming footer å¾®ä¿¡ link (ID is 'fb-link' in your HTML)
        const socialModal = document.getElementById('social-modal');
        const aboutModal = document.getElementById('about-modal');
        const qrCodeImage = document.getElementById('qr-code-image');
        const modalCloses = document.querySelectorAll('.modal-close');


        // --- State Variables ---
        let currentPath = '';
        let isDarkMode = false;
        let viewer = null;
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.tif', '.tiff'];
        const baseImageDir = 'SYSTEM'; // Base directory for constructing image URLs (relative to index.html)

        // --- NEW: Variable to store the loaded JSON file structure ---
        let fileStructure = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Load theme preference
            loadThemePreference();

            // --- Fetch the file list JSON ---
            try {
                const response = await fetch('filelist.json'); // Fetch the JSON file from the root
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                }
                fileStructure = await response.json(); // Parse and store the JSON
                console.log("File structure loaded:", fileStructure); // Optional: check console

                // Initial gallery load (after JSON is loaded)
                const initialPath = window.location.hash.substring(1);
                loadGallery(initialPath || ''); // Load initial path or root

            } catch (error) {
                console.error('Failed to load file structure:', error);
                galleryElement.innerHTML = `<div class="empty-message">é”™è¯¯ï¼šæ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨ (filelist.json)ã€‚<br>è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨äºç½‘ç«™æ ¹ç›®å½•ä¸”æ ¼å¼æ­£ç¡®ã€‚<br>${error.message}</div>`;
            }

            // Hash change listener
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.substring(1);
                // Only reload if the hash actually changed and JSON is loaded
                if (hash !== currentPath && fileStructure) {
                    loadGallery(hash);
                }
            });

            // Setup other event listeners
            setupEventListeners();
        });

        // --- Theme Handling ---
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                document.body.classList.add('dark-mode');
                isDarkMode = true;
                 themeToggle.textContent = isDarkMode ? 'åˆ‡æ¢äº®è‰²' : 'åˆ‡æ¢æš—è‰²'; // Adjust text based on actual button content
            } else {
                 themeToggle.textContent = isDarkMode ? 'åˆ‡æ¢äº®è‰²' : 'åˆ‡æ¢æš—è‰²';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            themeToggle.textContent = isDarkMode ? 'åˆ‡æ¢äº®è‰²' : 'åˆ‡æ¢æš—è‰²'; // Adjust text
        }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            themeToggle.addEventListener('click', toggleTheme);

            // Image Viewer Controls
            closeViewer.addEventListener('click', closeImageViewer);
            infoToggle.addEventListener('click', toggleInfoPanel);
            zoomIn.addEventListener('click', () => { if (viewer) viewer.viewport.zoomBy(1.5); });
            zoomOut.addEventListener('click', () => { if (viewer) viewer.viewport.zoomBy(0.5); });
            home.addEventListener('click', () => { if (viewer) viewer.viewport.goHome(); });
            fullPage.addEventListener('click', toggleFullScreenViewer);

             // Breadcrumb Navigation (delegated)
             breadcrumbElement.addEventListener('click', handleBreadcrumbClick);

            // Modal Triggers & Closing
             // Ensure links exist before adding listeners
             if (aboutLink) {
                aboutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(aboutModal);
                 });
             } else {
                 console.warn("About link not found for modal trigger.");
             }

             if (igLink) {
                 igLink.addEventListener('click', (e) => {
                     e.preventDefault();
                     qrCodeImage.src = 'assets/ig-qr.png'; // Assuming this path exists
                     qrCodeImage.alt = 'Instagram QR Code';
                     openModal(socialModal);
                 });
             } else {
                  console.warn("IG link not found for modal trigger.");
             }

             if (fbLink) {
                 fbLink.addEventListener('click', (e) => {
                     e.preventDefault();
                     qrCodeImage.src = 'assets/wc-qr.JPG'; // Use the correct path from your HTML
                     qrCodeImage.alt = 'Wechat QR Code';
                     openModal(socialModal);
                 });
             } else {
                 console.warn("Wechat/FB link ('#fb-link') not found for modal trigger.");
             }


             modalCloses.forEach(button => {
                 button.addEventListener('click', () => {
                     const modalId = button.getAttribute('data-modal-id');
                     const modalToClose = document.getElementById(modalId);
                     if (modalToClose) {
                         closeModal(modalToClose);
                     }
                 });
             });

             window.addEventListener('click', (e) => {
                 if (e.target === socialModal) closeModal(socialModal);
                 if (e.target === aboutModal) closeModal(aboutModal);
             });

            // Keyboard listeners (Escape key)
            document.addEventListener('keydown', handleKeyDown);
        }

        function handleKeyDown(e) {
             const viewerVisible = window.getComputedStyle(imageViewer).display !== 'none';
             const socialModalVisible = window.getComputedStyle(socialModal).display !== 'none';
             const aboutModalVisible = window.getComputedStyle(aboutModal).display !== 'none';

             if (e.key === 'Escape') {
                 if (viewerVisible) {
                     closeImageViewer();
                 } else if (socialModalVisible) {
                     closeModal(socialModal);
                 } else if (aboutModalVisible) {
                     closeModal(aboutModal);
                 }
             }
        }


        // --- JSON Navigation Helper ---
        function getNodeByPath(structure, path) {
            if (!structure) return null;
            // Handle root path explicitly targeting the initial structure from JSON
            if (path === '' || path === '/') {
                 // Assuming your JSON root IS the 'SYSTEM' directory object
                 if (structure.name === baseImageDir && structure.type === 'directory') {
                     return structure;
                 } else {
                      console.warn("JSON root does not match expected baseImageDir structure.");
                      return structure; // Fallback to returning the raw structure
                 }
            }

            const parts = path.split('/').filter(p => p); // Split path and remove empty parts
            let currentNode = structure; // Start from the loaded root JSON object

            for (const part of parts) {
                const decodedPart = decodeURIComponent(part); // Handle encoded names if necessary
                if (currentNode && currentNode.children && currentNode.children[decodedPart]) {
                    currentNode = currentNode.children[decodedPart];
                } else {
                    console.warn(`Part '${decodedPart}' not found in path '${path}' within JSON node:`, currentNode);
                    return null; // Path segment not found
                }
            }
            return currentNode;
        }

        // --- Gallery Loading (Uses JSON) ---
        function loadGallery(path) {
            if (!fileStructure) {
                galleryElement.innerHTML = '<div class="empty-message"><div class="loader"></div>æ–‡ä»¶åˆ—è¡¨å°šæœªåŠ è½½...</div>';
                console.error("loadGallery called before file structure was loaded.");
                return;
            }

            console.log(`Loading gallery for path: '${path}'`); // Debugging
            currentPath = path;
            updateBreadcrumb(path);
            updateGalleryTitle(path); // Update title based on the target directory name
            updateActiveNavLink(path);

            // Navigate the JSON based on the path
            const currentNode = getNodeByPath(fileStructure, path);
            console.log("Current JSON node:", currentNode); // Debugging

            galleryElement.innerHTML = ''; // Clear previous content

            if (!currentNode || currentNode.type !== 'directory') {
                console.error(`Path not found or not a directory in JSON: ${path}`);
                galleryElement.innerHTML = `<div class="empty-message">é”™è¯¯ï¼šæ— æ³•åœ¨æ–‡ä»¶åˆ—è¡¨æ‰¾åˆ°è·¯å¾„ '${path}'ã€‚</div>`;
                updateGalleryTitle(`é”™è¯¯`); // Indicate error in title
                return;
            }

             // Update title using the name from the JSON node if available
             updateGalleryTitle(path); // Use the path logic for now, can refine later

            // Check if the directory node has children
             if (!currentNode.children || Object.keys(currentNode.children).length === 0) {
                 galleryElement.innerHTML = '<div class="empty-message">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
                 return;
             }

            // Process directories and images from the JSON node's children
            const children = currentNode.children;
            let itemCount = 0;
            const sortedKeys = Object.keys(children).sort(); // Sort for consistency

            sortedKeys.forEach(itemName => {
                const item = children[itemName];
                const encodedItemName = encodeURIComponent(itemName); // Ensure name is URL-safe for path
                const newPath = path ? `${path}/${encodedItemName}` : encodedItemName; // Construct full path for item

                if (item.type === 'directory') {
                    itemCount++;
                    const folderElement = document.createElement('div');
                    folderElement.className = 'folder loading-cover'; // Add loading class for cover fetch
                    folderElement.innerHTML = `<div class="folder-name">${itemName}</div>`; // Use original name for display
                    folderElement.setAttribute('data-path', newPath); // Use URL-safe path for navigation
                    folderElement.addEventListener('click', (e) => {
                        const targetPath = e.currentTarget.getAttribute('data-path');
                        window.location.hash = `#${targetPath}`; // Use hash change to trigger load
                    });
                    galleryElement.appendChild(folderElement);
                    fetchAndSetFolderCover(newPath, folderElement); // Fetch cover using URL-safe path
                } else if (item.type === 'file') {
                     const extension = itemName.substring(itemName.lastIndexOf('.')).toLowerCase();
                     if (imageExtensions.includes(extension)) {
                         itemCount++;
                         const imageElement = document.createElement('div');
                         imageElement.className = 'image-item';
                         // Construct URL: Base Dir + Full Path (already includes filename)
                         const imageUrl = `${baseImageDir}/${path ? path + '/' : ''}${itemName}`; // Use original names for URL construction
                         // const imageDisplayName = itemName; // Use original name for display/alt text

                         // Apply filename-only logic for display if needed, otherwise use full name
                         const lastDot = itemName.lastIndexOf('.');
                         const nameForDisplay = lastDot > 0 ? itemName.substring(0, lastDot) : itemName;

                         // Note: Your HTML included '.image-name' again. Uncomment if needed.
                         imageElement.innerHTML = `<img src="${imageUrl}" alt="${nameForDisplay}" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML += '<p style=\\'color:red; padding:10px;\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>';">`;
                         // + `<div class="image-name">${nameForDisplay}</div>`; // Uncomment if you want the hover name back

                         imageElement.addEventListener('click', () => {
                             showImageViewer(imageUrl, itemName); // Pass URL and original filename (for info panel)
                         });
                         galleryElement.appendChild(imageElement);
                     }
                }
            });

             if (itemCount === 0 && galleryElement.children.length === 0) { // Check if really empty after filtering
                 galleryElement.innerHTML = '<div class="empty-message">æ­¤æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰å›¾ç‰‡æˆ–å­ç›®å½•ã€‚</div>';
             }
        }

        // --- Folder Cover Loading (Uses JSON) ---
        function fetchAndSetFolderCover(folderPath, folderElement) {
            if (!fileStructure) return; // Guard against race condition

            const folderNode = getNodeByPath(fileStructure, folderPath);
            folderElement.classList.remove('loading-cover'); // Remove spinner once processed

            if (!folderNode || folderNode.type !== 'directory' || !folderNode.children) {
                 folderElement.style.backgroundImage = 'none';
                 folderElement.classList.remove('has-cover');
                 // Optionally add an error class if node not found vs. just empty
                 if (!folderNode) folderElement.classList.add('has-error');
                return;
            }

            let coverImageUrl = null;
            const childrenKeys = Object.keys(folderNode.children).sort();
            for (const itemName of childrenKeys) {
                const item = folderNode.children[itemName];
                if (item.type === 'file') {
                    const extension = itemName.substring(itemName.lastIndexOf('.')).toLowerCase();
                    if (imageExtensions.includes(extension)) {
                         // Construct URL: Base Dir + Folder Path + Item Name
                         // Need original names here for the URL path segments
                         const originalPathSegments = folderPath.split('/').map(decodeURIComponent).join('/');
                         coverImageUrl = `${baseImageDir}/${originalPathSegments}/${itemName}`;
                         break;
                    }
                }
            }

            if (coverImageUrl) {
                folderElement.style.backgroundImage = `url('${coverImageUrl}')`;
                folderElement.classList.add('has-cover');
                folderElement.classList.remove('has-error'); // Remove error if cover is found
            } else {
                folderElement.style.backgroundImage = 'none';
                folderElement.classList.remove('has-cover');
                folderElement.classList.remove('has-error'); // Not an error if just empty
            }
        }

        // --- UI Update Functions ---
        function updateBreadcrumb(path) {
            // Use baseImageDir from JSON if available, otherwise fallback
            const rootDisplayName = fileStructure?.name || baseImageDir;
            let html = `<a href="#/" data-path="">${rootDisplayName}</a>`; // Link to root hash
            let currentBuildPath = '';
            if (path) {
                const parts = path.split('/');
                parts.forEach((part) => {
                    if (!part) return;
                    const decodedPart = decodeURIComponent(part); // Display decoded name
                    // Build path using encoded parts for the href/data-path
                    currentBuildPath += (currentBuildPath ? '/' : '') + part;
                    html += ` <span>/</span> <a href="#${currentBuildPath}" data-path="${currentBuildPath}">${decodedPart}</a>`;
                });
            }
            breadcrumbElement.innerHTML = html;
            // Event listener is delegated in setupEventListeners, no need to re-attach
        }

        function handleBreadcrumbClick(e) {
            if (e.target.tagName === 'A' && e.target.hasAttribute('data-path')) {
                e.preventDefault();
                const pathToLoad = e.target.getAttribute('data-path');
                // Use hash change to trigger navigation and history
                window.location.hash = `#${pathToLoad}`;
            }
        }

        function updateGalleryTitle(path) {
             if (!path) {
                 galleryTitleElement.textContent = fileStructure?.name || baseImageDir;
             } else {
                 const parts = path.split('/');
                 galleryTitleElement.textContent = decodeURIComponent(parts[parts.length - 1]); // Show last part decoded
             }
         }

        function updateActiveNavLink(path) {
             // This function needs adjustment based on your final nav links if they relate to paths
             // Currently, it only highlights "é¦–é¡µ" when path is empty
             mainNavLinks.forEach(link => {
                 link.classList.remove('active');
                 // Check if the link's href corresponds to the current base path
                 // This logic might need refinement depending on nav structure
                 if (link.getAttribute('href') === '#/' && (path === '' || path === '/')) {
                     link.classList.add('active');
                 }
                 // Add logic here if other nav links should be active based on path
             });
             // Ensure home is not active if navigating deeper
             if(path !== '' && path !== '/') {
                 const homeLink = document.querySelector('.main-nav a[href="#/"]');
                 if (homeLink) homeLink.classList.remove('active');
             }
         }

        // --- Image Viewer Functions ---
        function showImageViewer(src, originalFilename) { // Use original filename for info panel
            imageViewer.style.display = 'block';

            // Extract filename without extension for display
            const lastDotIndex = originalFilename.lastIndexOf('.');
            const filenameWithoutExtension = lastDotIndex > 0 ? originalFilename.substring(0, lastDotIndex) : originalFilename;

            // Set info panel content
            imageTitle.textContent = filenameWithoutExtension; // Show filename without ext in title
            imageInfo.textContent = `æ–‡ä»¶å: ${filenameWithoutExtension}`; // Show filename without ext in info

            infoPanel.classList.remove('visible');
            infoToggle.textContent = 'æ˜¾ç¤ºä¿¡æ¯';

            if (viewer) { viewer.destroy(); viewer = null; }
            viewer = OpenSeadragon({
                id: "viewer-container",
                prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/3.1.0/images/",
                tileSources: { type: 'image', url: src, buildPyramid: false }, // Use the direct image URL
                showNavigator: true,
                navigatorPosition: "BOTTOM_RIGHT",
                animationTime: 0.5,
                blendTime: 0.1,
                constrainDuringPan: true,
                maxZoomPixelRatio: 2,
                minZoomLevel: 0.5,
                visibilityRatio: 0.5,
                zoomPerScroll: 1.2,
                gestureSettingsMouse: { clickToZoom: true, dblClickToZoom: true },
                showNavigationControl: false, // Use custom buttons
                showZoomControl: false,
                showHomeControl: false,
                showFullPageControl: false,
                showRotationControl: false
            });
            viewer.addHandler('open', function() {
                viewer.viewport.goHome(false); // Go home without animation on open
            });
             viewer.addHandler('canvas-click', function() { // Optional: Close info panel on click
                 if (infoPanel.classList.contains('visible')) {
                      toggleInfoPanel();
                 }
             });
        }

        function closeImageViewer() {
            imageViewer.style.display = 'none';
            if (viewer) {
                viewer.destroy();
                viewer = null;
            }
        }

        function toggleInfoPanel() {
            infoPanel.classList.toggle('visible');
            infoToggle.textContent = infoPanel.classList.contains('visible') ? 'éšè—ä¿¡æ¯' : 'æ˜¾ç¤ºä¿¡æ¯';
        }

        function toggleFullScreenViewer() {
             if (!document.fullscreenElement) {
                  imageViewer.requestFullscreen().catch(err => {
                      console.error(`Fullscreen request failed: ${err.message} (${err.name})`);
                      alert('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼ã€‚');
                  });
              } else {
                   document.exitFullscreen();
              }
        }


        // --- Modal Control Functions ---
        function openModal(modalElement) {
            if(modalElement) modalElement.style.display = 'flex';
        }

        function closeModal(modalElement) {
             if(modalElement) modalElement.style.display = 'none';
        }

    </script>
</body>
</html>